name: Playwright Tests

on: [push]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright
        run: npx playwright install

      - name: Run Playwright tests
        run: npx playwright test basic/softstaking.spec.js --reporter=junit
        continue-on-error: true

      - name: Install Tuskr CLI
        run: npm install -g tuskr

      - name: Collect screenshots and videos
        run: |
          mkdir -p collected-artifacts
          cp results.xml collected-artifacts/
          find test-results -type f \( -name "*.png" -o -name "*.webm" \) -exec cp {} collected-artifacts/ \;

      - name: Create ZIP for Tuskr upload
        run: zip -j results.zip collected-artifacts/*

      - name: Upload results to Tuskr
        run: |
          tuskr \
            --project=${{ secrets.PLAYWRIGHTPROJECT }} \
            --test-run-name="Basic playwright test TIMESTAMP=$(date +'%Y-%m-%d_%H-%M-%S')" \
            --api-token=${{ secrets.PLAYWRIGHTAPITOKEN }} \
            --file="results.zip" \
            --test-case-rules="rules/test-case-rules-basic.json"
